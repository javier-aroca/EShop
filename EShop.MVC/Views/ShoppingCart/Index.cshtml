@using EShop.MVC.Models
@using EShop.MVC.Models
@model IEnumerable<ShoppingCartList>

@{
    ViewBag.Title = "Index";
}

<h2>Listado de productos en el carrito</h2>


<script>
    // script que valida la tarjeta segun algoritmo de Luhn
    function isValidCard(cardNumber) {
        var cardNumbersUpsideDown = cardNumber.split("").reverse(); // array de numeros al revés
        var j = 1; // contador de posiciones pares (impares en js)
        var sum = 0; // almacenar la suma de los numeros de la tarjeta
        for (var i = 0; i < cardNumbersUpsideDown.length; i++) { // bucle para recorrer el array
            cardNumbersUpsideDown[i] = parseInt(cardNumbersUpsideDown[i]); // convertir en un entero el número en esa posición

            // si encontramos una posicion par (impar en js)
            if (i === j) {
                cardNumbersUpsideDown[j] *= 2; // multiplicar por 2 los numeros de las posiciones pares(impares en js)

                if (cardNumbersUpsideDown[j] >= 10) { // si la multiplicación es mayor o igual a 10
                    cardNumbersUpsideDown[j] = cardNumbersUpsideDown[j].toString(); // convertir el numero en string
                    var separateNumbers = cardNumbersUpsideDown[j].split(''); // separar las cifras del numero
                    //convertir las cifras en numeros enteros con parseInt
                    separateNumbers[0] = parseInt(separateNumbers[0]);
                    separateNumbers[1] = parseInt(separateNumbers[1]);
                    cardNumbersUpsideDown[j] = separateNumbers[0] + separateNumbers[1]; // sumar las cifras
                }
                j += 2; // De lo contrario si la multiplicación es menor que 10 aumentar j en 2
            }
            sum += cardNumbersUpsideDown[i]; // suma de numeros en posiciones impares y nuevos numeros en posiciones pares
        }
        var messageToTheUser; // mensaje que se retornará al usuario
        sum % 10 === 0 ? messageToTheUser = 'Tarjeta de crédito válida' :
            messageToTheUser = 'Tarjeta de crédito no válida';
        return messageToTheUser; //retornar el mensaje

        //TODO: procesar el no pago del TPV
        return sum % 10 === 0 ? true : false;
    }


    function onClickConfirmarCompra()
    {
        debugger;
        if (true /*Date.parse(document.getElementById("cardDate").value) > new Date()*/) {
            if (isValidCard(document.getElementById("cardNumber").value) && (parseInt(document.getElementById("cardNumber").value) % 2 == 0)) {
                location.href = '/ShoppingCart/CreateOrder?address=' + document.getElementById('address').value;
            }
            else {//TODO: if (parseInt(document.getElementById("cardNumber").value) % 2 != 0)
                alert("El número de tarjeta no es válido");
            }
        }
        else {
            alert("La tarjeta no es válida o está caducada");
        }
        
    }
</script>

<table class="table">
    <tr>
        @*        <th>
                <p>Borrar Producto</p>

            </th>*@
@*        <th>
            @Html.DisplayNameFor(model => model.Id)
        </th>*@
        <th>
            @Html.DisplayNameFor(model => model.Product)
        </th>
        <th>
            @Html.DisplayNameFor(model => model.Quantity)
        </th>
@*        <th>
            Total Producto
        </th>*@
        @*        <th>
                @Html.DisplayNameFor(model => model.Amount)
            </th>*@
        <th></th>
    </tr>

  

    @foreach (var item in Model)
    {

@*        int lineTotal = Convert.ToInt32(item.Quantity * )*@
        <tr>

            @*< !--< td > -->*@
            @*botón que borra un producto del carrito del cliente*@
            <!--<input type="button"
                       value="Eliminar del carrito"
                       onclick="alert('Producto eliminado del carrito'); location.href='@Url.Action("SubstractFromCartView", "ShoppingCart", new { idShoppingCart = item.Id })'" />
            </td>-->

@*            <td>
                @Html.DisplayFor(modelItem => item.Id)
            </td>*@
            <td>
                @Html.DisplayFor(modelItem => item.Product.Name) 
                
            </td>
            <td>
                @Html.DisplayFor(modelItem => item.Quantity)
            </td>
            @*    <td>
                    @Html.DisplayFor(modelItem => item.Amount)
                </td>*@
            <td>
                @* @Html.ActionLink("Edit", "Edit", new { id = item.Id }) |*@
             @*   @Html.ActionLink("Detalle", "Details", new { id = item.Id }) |*@
                @Html.ActionLink("Eliminar", "Delete", new { id = item.Id })
            </td>
         </tr>
    }

</table>


<dl>
    <p><label for="address">Dirección de envío:</label></p>

    <p><input type="text" id="address" name="address"></p>

    <p><label for="cardNumber">Número de tarjeta:</label></p>
    <p><input type="text" id="cardNumber" name="cardNumber"></p>

    <p><label for="cardDate">Caducidad:</label></p>
    <p><input type="text" id="cardDate" name="cardDate"></p>
</dl>

<input type="button"
       value="Confirmar compra"
       @*onclick="location.href = '@{Url.Action("CreateOrder", "ShoppingCart", }' + "new { address = " + document.Get'"*@
        onclick="onClickConfirmarCompra()"
       }); />

